## DVP光谱异常检测模型优化方案 V4.0

生成时间: 2025-10-31  
适用代码: `scripts/evaluate.py`、`scripts/train.py`

### 1. 本阶段目标与结论
- 目标：修复评估与组合策略问题，稳定质量子模型表现，提升稳定性子模型可用性；明确训练数据选择策略。
- 结论：
  - 质量子模型（Quality）已稳定优秀（AUC≈0.987，F1≈0.91，阈值经优化≈0.971）。
  - 稳定性子模型（Stability）在方向修正与阈值优化后，短期可用（本轮典型 F1≈0.45），但AUC波动，需在训练与数据侧继续优化。
  - 组合模型经修复后 AUC≈0.95，F1≈0.89，可作为当前推荐输出。

---

### 2. 代码层优化（已落地）
1) 评估层
- 阈值优化默认使用 `youden`；保留 `f1/none` 可选。
- 稳定性分数自动方向修正：若探测到 `AUC_probe < 0.55`，对分数取反并在此方向上进行阈值优化、预测与AUC计算。
- 组合分数修正：先统一异常方向并做 Min-Max 归一化，再按单模型 AUC 做加权融合（动态权重）。
- 质量阈值单位归一：若来自元数据的阈值>1，自动除以100（百分比→[0,1]）。
- 详细日志：打印 `flipped_stability`、`auc_probe_stability`、最终阈值与组合权重。

2) 训练层
- 标准曲线生成从批量样本矩阵稳健汇聚：默认中位数，支持 `--std_curve_agg mean`。
- 数据健壮性校验：核对 `wavelengths/dvp_values` 存在、列数一致、无 NaN。
- 相对路径加载 `data/dvp_processed_data.npz`，避免环境依赖。

---

### 3. 数据选择策略（关键）
- 自编码器（Stability）训练集仅用“高置信正常”样本，学习正常分布；不要将明显偏大的偏差样本直接混入训练。
- 可引入“受控的小幅偏差”增强泛化：在高置信正常的阈值基础上放宽5-10%的带宽，小比例引入；或采用课程学习（逐步扩大带宽）。
- 将“差值较大”的样本用于验证/测试与阈值优化（youden/F1），而非用于自编码器权重拟合。
- 若确需引入更偏的样本到训练：对其降低样本权重，或分阶段少量引入并观察 AUC/F1 变化。

筛选建议（示例）：
- 计算每条样本相对标准曲线的 Quality Score 与残差/重构误差。
- 训练集：Quality≥P80/P90 且 残差≤P90/P95，按批次/时间分层抽样，覆盖不同工况。
- 验证/测试：纳入差值更大的样本，用于阈值选择与最终评估。

---

### 4. 使用指引
- 训练（示例）
```
python scripts/train.py --coating_name DVP --version v1.2 --std_curve_agg median
```

- 评估（默认 youden + 自动方向修正 + AUC加权融合）
```
python scripts/evaluate.py --samples 1000 --random-seed 42 --model-dir models/DVP/v1.2
```

可选：
```
# 改用F1阈值优化对比
python scripts/evaluate.py --samples 1000 --random-seed 42 --model-dir models/DVP/v1.2 --optimize-thresholds f1
```

---

### 5. 后续优化路线（优先级顺序）
1) 数据与异常设计：
   - 扩充高置信正常训练集，覆盖更多工况；
   - 构造贴近工艺的异常类型（整体偏移、局部段漂移、峰位/带宽变化、阶跃等）。
2) 模型与正则化：
   - 扩大自编码器容量（81→64→32→16→8→… 对称解码），加入L2/Dropout与早停；
   - 重新设计波段权重，或尝试学习式注意力替代固定权重。
3) 特征与判别：
   - 基于重构误差的分段统计（各波段均值/分位数/峰值差）+ 轻量分类器（LogReg/GBDT）做基线；
   - 与自编码器方案做AB对比，选择泛化更好的路径。
4) 监控与校准：
   - 监控阈值漂移与数据分布漂移，定期复评阈值；
   - 报告中补充PR曲线、阈值灵敏度曲线与分布可视化。

---

### 6. 变更摘要（与V3相比）
- 新增：质量阈值单位归一（>1自动/100）。
- 放宽：稳定性方向自动修正触发阈值从 AUC<0.5 → AUC<0.55。
- 优化：组合分数按单模型 AUC 动态加权（替代等权）。
- 强化：训练数据选择策略，明确“正常训练 + 偏差验证”的分工与课程学习思路。


