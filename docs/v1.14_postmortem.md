# v1.14_quality_17k 失败分析与改进方案

**日期**: 2025-11-01  
**状态**: ❌ 失败 - 严重过拟合

---

## 问题总结

v1.14尝试通过提高训练数据质量（88.1%高质量样本）来改进Stability Score，但导致**严重过拟合**：

### 性能崩溃

| 指标 | v1.12_varsm | v1.14_quality | 下降幅度 |
|-----|------------|--------------|---------|
| Quality AUC | 0.987 | **0.589** | **-40.3%** |
| Combined F1 | 0.884 | **0.424** | **-52.0%** |
| Combined 准确率 | 0.954 | **0.480** | **-49.7%** |

### 根本原因

1. **训练数据过于纯净**
   - 质量阈值P70（v1.12为P80）
   - 高质量占比88.1%（v1.12为83.5%）
   - edge占比仅11.9%（v1.12为16.4%）

2. **模型失去泛化能力**
   - 训练R²=0.9265（过高）
   - 阈值仅0.887（异常低，说明只识别完美样本）
   - 无法处理正常范围内的质量波动

3. **训练/测试分布不匹配**
   - 训练：超高质量样本
   - 测试：真实正常样本（包含正常波动）
   - 模型将正常波动误判为异常

---

## 经验教训

### ❌ 错误假设

> "数据质量越高 → 模型性能越好"

**现实**: 过度纯净的训练数据导致模型**无法泛化到正常质量波动**。

### ✅ 正确理解

**异常检测的本质**：区分"正常波动"与"真正异常"

- **正常波动**：质量在P60-P90范围内的样本
- **真正异常**：远离正常分布的样本

如果训练数据只包含P70+样本，模型会将P60-P70的**正常样本**误判为异常。

---

## 改进方案

### v1.15: 平衡质量与多样性

**目标**: 训练R²≈0.85-0.88（避免>0.90过拟合）

**数据筛选参数**:

| 参数 | v1.12 | v1.14 | v1.15(推荐) |
|-----|-------|-------|------------|
| 质量最低阈值 | P80 | P70 | **P75** |
| 高质量阈值 | P85 | P90 | **P87** |
| 高质量占比 | 83.5% | 88.1% | **≈85%** |
| Edge占比 | 16.4% | 11.9% | **≈15%** |
| 目标样本数 | 21301 | 17655 | **≈25000** |

**预期效果**:
- 训练R²: 0.85-0.88（防止过拟合）
- Combined F1: ≥0.90（回到可用水平）
- Stability AUC: 0.60+（达标）

### 训练命令

```bash
# 步骤1：筛选数据
python scripts/select_training_data.py \
    --input data/all_data.csv \
    --output-dir data/selection_v15 \
    --high-sim-pctl 87 \
    --high-pearson-pctl 90 \
    --sim-min-pctl 75 \
    --pearson-min-pctl 75 \
    --edge-max-ratio 0.15 \
    --train-ratio 0.70 \
    --val-ratio 0.15

# 步骤2：导出训练数据
python scripts/export_training_subset.py \
    --input data/all_data.csv \
    --index-dir data/selection_v15 \
    --output-dir data/export_v15

# 步骤3：训练模型
python scripts/train.py \
    --coating_name DVP \
    --version v1.15_balanced_25k \
    --data-npz data/export_v15/train_subset.npz \
    --weights-mode variance_smooth \
    --ae-alpha 0.00025

# 步骤4：评估（使用真实测试数据）
python3 scripts/evaluate.py \
    --model-dir models/DVP/v1.15_balanced_25k \
    --optimize-thresholds f1 \
    --test-data-npz data/export_v15/test_subset.npz
```

---

## 关键建议

### 1. 训练数据质量平衡

**不要追求极端纯净的训练数据**，应包含：
- **核心正常样本**（P85+）：70-75%
- **边缘正常样本**（P70-P85）：20-25%
- **轻微偏差样本**（P60-P70）：5-10%

### 2. 监控训练R²

- **R² < 0.80**: 欠拟合，增加样本或调整模型
- **R² = 0.80-0.88**: ✅ 理想区间
- **R² > 0.90**: ⚠️ 过拟合风险，降低数据纯度

### 3. 使用真实测试数据

**混合测试集**（80%真实正常 + 20%合成异常）比纯合成数据更能反映真实性能。

---

## 结论

**v1.12_varsm_21k 仍是当前最佳版本**：
- Combined F1: 0.884
- Stability AUC: 0.564
- 平衡了性能与泛化能力

**下一步**：
1. ✅ 使用v1.12作为生产版本
2. 🔄 按v1.15方案重新训练（平衡质量与多样性）
3. 🎯 目标：Combined F1≥0.90，Stability AUC≥0.60

---

*分析完成时间: 2025-11-01*  
*作者: AI Agent*

