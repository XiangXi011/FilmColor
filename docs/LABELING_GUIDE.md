# DVP光谱异常检测 - 人工标注指南

**版本**: v1.0  
**日期**: 2025-11-01  
**目标**: 为半监督学习提供高质量标注数据  

---

## 📋 标注任务概述

### 任务目标
标注150-200个DVP涂层光谱样本，判断每个样本是**正常**还**异常**。

### 标注文件
- **输入文件**: `output/label_candidates_spectra_v1.12.csv`
- **输出文件**: `output/label_candidates_v1.12_labeled.csv`

### 标注时间
- 预计4-6小时（平均每个样本1-2分钟）
- 可分批完成（建议每次标注50个）

---

## 🎯 标注标准

### Label定义

| Label值 | 含义 | 判断标准 |
|---------|------|---------|
| **0** | 正常 | 光谱曲线符合标准，无明显异常 |
| **1** | 异常 | 存在以下任一异常情况 |

### 异常判断准则（满足任一即为异常）

#### 1. 峰值位置偏移
- **正常**: 峰值在550±5nm范围内
- **异常**: 峰值偏移 > 5nm（如545nm以下或555nm以上）

#### 2. 峰值强度异常
- **正常**: 峰值反射率在85-100%范围内
- **异常**: 
  - 峰值过低（< 85%）
  - 峰值过高（> 100%，可能是噪声）

#### 3. 曲线形状异常
- **正常**: 曲线平滑，呈钟形分布
- **异常**:
  - 出现多峰（应该只有一个主峰）
  - 曲线断裂、突变
  - 边缘急剧下降/上升

#### 4. 噪声干扰
- **正常**: 曲线连续平滑
- **异常**:
  - 出现毛刺（突然跳变）
  - 锯齿状波动
  - 明显的随机噪声

#### 5. 整体偏移
- **正常**: 整体反射率在合理范围（400-780nm）
- **异常**:
  - 整体过低（全谱段< 50%）
  - 整体过高（全谱段> 110%）
  - 基线漂移

---

## 📊 标注流程

### Step 1: 打开标注文件

使用Excel或任意CSV编辑器打开：
```
output/label_candidates_spectra_v1.12.csv
```

文件格式：
```
index, quality_score, stability_score, 400.0, 401.0, ..., 780.0
0,     0.85,          3.5,             92.3,  93.1, ..., 85.2
1,     0.72,          5.2,             88.5,  89.3, ..., 82.1
...
```

### Step 2: 添加label列

在最后一列添加`label`列（或在第4列添加，便于查看）：
```
index, quality_score, stability_score, label, 400.0, 401.0, ...
0,     0.85,          3.5,             0,     92.3,  93.1,  ...
1,     0.72,          5.2,             1,     88.5,  89.3,  ...
```

### Step 3: 逐行标注

对每一行光谱数据：
1. **查看辅助信息**：
   - `quality_score`: 接近1表示质量好，接近0表示质量差
   - `stability_score`: 值越大表示重构误差越大（越可能异常）
   
2. **判断异常**：
   - 参考上述5条异常判断准则
   - 在`label`列填写`0`（正常）或`1`（异常）

3. **可选：添加注释**：
   - 可添加`comment`列记录异常原因
   - 例如："峰值偏移10nm" 或 "曲线有毛刺"

### Step 4: 保存文件

保存为：
```
output/label_candidates_v1.12_labeled.csv
```

**注意**：
- 确保列名包含`label`（大小写可能敏感）
- 确保label值为整数`0`或`1`（不要有空格或其他字符）
- 确保CSV格式正确（逗号分隔）

---

## 🔍 标注技巧

### 技巧1: 利用辅助指标

优先标注这些样本：
- `quality_score`接近阈值0.76的样本（决策边界）
- `stability_score`接近阈值-10.0的样本
- `uncertainty`值最小的前50个样本（最不确定）

### 技巧2: 绘制光谱曲线

可以使用Python快速绘制曲线辅助判断：

```python
import pandas as pd
import matplotlib.pyplot as plt

# 读取数据
df = pd.read_csv('output/label_candidates_spectra_v1.12.csv')

# 提取波长列（400-780nm）
wavelength_cols = [col for col in df.columns if col.replace('.','').isdigit()]
wavelengths = [float(col) for col in wavelength_cols]

# 绘制第一个样本
sample_idx = 0
spectrum = df.loc[sample_idx, wavelength_cols].values
plt.plot(wavelengths, spectrum)
plt.xlabel('Wavelength (nm)')
plt.ylabel('Reflectance (%)')
plt.title(f'Sample {sample_idx}')
plt.grid(True)
plt.show()
```

### 技巧3: 批量标注

- **先标注明显异常**：快速浏览数据，先标注明显异常的样本
- **再标注明显正常**：标注明显正常的样本
- **最后处理边界样本**：仔细判断不确定的边界样本

### 技巧4: 双人验证

对于不确定的样本：
- 标记为`label = -1`（临时标记）
- 与另一名专家讨论
- 达成一致后更新为`0`或`1`

---

## 📖 典型案例

### 案例1: 正常样本

```
Spectrum: [52.1, 55.3, 60.2, ..., 95.8, 96.2, ..., 85.3, 82.1]
         (400nm)              (550nm peak)        (780nm)

特征:
- 峰值位置: 550nm ✅
- 峰值强度: 96.2% ✅
- 曲线平滑: 无毛刺 ✅
- 形状正常: 单峰钟形 ✅

标注: label = 0
```

### 案例2: 峰值偏移异常

```
Spectrum: [48.3, 52.1, 58.9, ..., 94.5, 95.1, ..., 87.2, 84.5]
         (400nm)              (540nm peak!)       (780nm)

特征:
- 峰值位置: 540nm ❌ (偏移-10nm)
- 峰值强度: 95.1% ✅
- 曲线平滑: 正常 ✅

异常原因: 峰值位置偏移超过5nm阈值

标注: label = 1
```

### 案例3: 强度异常

```
Spectrum: [45.2, 48.5, 55.3, ..., 78.2, 79.5, ..., 71.3, 68.9]
         (400nm)              (550nm peak)        (780nm)

特征:
- 峰值位置: 550nm ✅
- 峰值强度: 79.5% ❌ (低于85%阈值)
- 曲线平滑: 正常 ✅

异常原因: 峰值强度过低，可能反射率不足

标注: label = 1
```

### 案例4: 噪声干扰

```
Spectrum: [50.2, 85.3, 55.1, ..., 94.2, 62.8, 96.1, ..., 83.5]
         (400nm) (突变!)              (噪声!)

特征:
- 峰值位置: 不明确 ❌
- 曲线平滑: 有明显跳变 ❌
- 存在噪声: 多处突变点 ❌

异常原因: 数据采集过程有干扰

标注: label = 1
```

### 案例5: 边界样本（难以判断）

```
Spectrum: [51.5, 54.8, 59.3, ..., 92.8, 93.1, ..., 84.7, 81.2]
         (400nm)              (548nm peak)        (780nm)

特征:
- 峰值位置: 548nm ⚠️ (偏移-2nm，在边界)
- 峰值强度: 93.1% ✅
- 曲线平滑: 正常 ✅

判断:
- 偏移-2nm < 5nm阈值 → 技术上正常
- 但略有偏移 → 可能是边缘样本

建议标注: label = 0 (正常，偏移未超阈值)
```

---

## ⚠️ 常见错误

### 错误1: 过度依赖辅助指标

❌ **错误做法**:
```
quality_score = 0.65 < 0.76 → label = 1 (自动判异常)
```

✅ **正确做法**:
```
quality_score = 0.65 → 参考指标，但仍需查看光谱数据
如果光谱曲线实际正常 → label = 0
```

**原因**: 辅助指标可能有误判，人工标注是为了提供"真实标签"纠正模型偏差

### 错误2: 标准过于严格

❌ **错误做法**:
```
峰值偏移1nm → label = 1 (过于严格)
```

✅ **正确做法**:
```
峰值偏移1nm → 在正常波动范围内 → label = 0
只有偏移 > 5nm才判为异常
```

### 错误3: 标准过于宽松

❌ **错误做法**:
```
峰值强度75% → "还能接受" → label = 0
```

✅ **正确做法**:
```
峰值强度75% < 85%阈值 → label = 1 (异常)
严格按照标准判断
```

### 错误4: 遗漏明显噪声

❌ **错误做法**:
```
曲线整体正常，忽略少量毛刺 → label = 0
```

✅ **正确做法**:
```
存在明显毛刺/噪声 → label = 1
任何明显的数据质量问题都应标记为异常
```

---

## 📊 质量控制

### 一致性检验

建议30%样本进行双人标注：
- 随机选择60个样本
- 两人独立标注
- 计算一致性：Cohen's Kappa系数

**目标**: Kappa ≥ 0.80（高一致性）

**如果Kappa < 0.80**:
- 讨论不一致样本
- 统一判断标准
- 重新标注部分样本

### 标注进度跟踪

| 阶段 | 样本数 | 预计时间 | 状态 |
|-----|-------|---------|------|
| Top 50不确定样本 | 50 | 1-1.5小时 | ⏳ 待完成 |
| 次优100样本 | 100 | 2-3小时 | ⏳ 待完成 |
| 补充50样本（可选） | 50 | 1-1.5小时 | ⏳ 待完成 |
| **总计** | **150-200** | **4-6小时** | |

---

## 🎓 培训建议

### 标注前培训（30分钟）

1. **阅读本指南**（15分钟）
2. **观看示例案例**（10分钟）
3. **练习标注10个样本**（5分钟）
   - 与标准答案对比
   - 讨论不一致原因

### 标注中答疑

- 建立专家组微信群/邮件组
- 遇到疑难样本随时讨论
- 每标注50个样本休息10分钟

### 标注后复查

- 抽查10-20个样本
- 确认标注质量
- 记录常见错误类型

---

## 📞 支持与帮助

### 技术支持
- **CSV格式问题**: 确保使用UTF-8编码，逗号分隔
- **数据导入问题**: 检查label列是否为整数0/1

### 标注疑问
- **不确定如何判断**: 参考典型案例，或咨询其他专家
- **边界样本**: 倾向于保守（疑似异常可标为异常）

### 联系方式
- AI助手支持: 通过项目issues提问
- 技术文档: `docs/SEMI_SUPERVISED_LEARNING_PLAN.md`

---

## 🚀 快速开始

**最小可行标注**（快速验证）：
1. 只标注Top 50最不确定样本
2. 训练残差分类器
3. 评估效果
4. 如果效果不佳，再补充标注100-150个

**完整标注**（最佳效果）：
1. 标注200个候选样本
2. 包含边界样本、典型样本、边缘样本
3. 确保正负样本比例合理（67% vs 33%）

---

**准备好了吗？开始标注！** 💪

祝标注顺利！如有任何问题，随时查阅本指南或寻求帮助。

